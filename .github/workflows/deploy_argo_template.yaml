name: Deploy & Run Argo Build

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-argo-template:
    runs-on: self-hosted
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Kubernetes namespace (prod vs dev)
        run: |
          if [ "${GITHUB_REF}" = "refs/heads/main" ]; then
            echo "K8S_NAMESPACE=prod" >> $GITHUB_ENV
          else
            echo "K8S_NAMESPACE=dev" >> $GITHUB_ENV
          fi

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "v1.29.0"

      - name: Ensure namespace exists
        run: |
          sudo microk8s kubectl get ns $K8S_NAMESPACE || sudo microk8s kubectl create ns $K8S_NAMESPACE

      - name: Apply secrets
        run: |
          sudo microk8s kubectl -n $K8S_NAMESPACE create secret docker-registry ghcr-secret \
            --docker-server=ghcr.io \
            --docker-username=git \
            --docker-password=${{ secrets.GHCR_TOKEN }} \
            --dry-run=client -o yaml | sudo microk8s kubectl apply -f -

      - name: Apply WorkflowTemplates
        run: |
          sudo microk8s kubectl apply \
            -f argo/workflowtemplate-backtest.yaml \
            -f argo/workflowtemplate-build-push-ghcr.yaml

  trigger-build:
    runs-on: self-hosted
    needs: deploy-argo-template

    steps:
      - name: Set Kubernetes namespace (prod vs dev)
        run: |
          if [ "${GITHUB_REF}" = "refs/heads/main" ]; then
            echo "K8S_NAMESPACE=prod" >> $GITHUB_ENV
          else
            echo "K8S_NAMESPACE=dev" >> $GITHUB_ENV
          fi

      - name: Trigger Argo Build Workflow
        run: |
          sudo microk8s kubectl -n $K8S_NAMESPACE create -f argo/run-build.yaml
